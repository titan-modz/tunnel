#!/bin/bash
# ════════════════════════════════════════════════════════════════
#  KelpNodes Tunnel - Full 24/7 Systemd Installer
# ════════════════════════════════════════════════════════════════

set -e

SERVER="57.128.42.40"
SERVICE_NAME="kelpnodes"

echo "Installing KelpNodes Tunnel System..."

# Install autossh if missing
if ! command -v autossh >/dev/null 2>&1; then
    echo "Installing autossh..."
    apt update && apt install -y autossh
fi

# ════════════════════════════════════════════════════════════════
# Create systemd template
# ════════════════════════════════════════════════════════════════

cat > /etc/systemd/system/${SERVICE_NAME}@.service <<EOF
[Unit]
Description=KelpNodes Tunnel %i
After=network.target

[Service]
User=root
ExecStart=/usr/bin/autossh -M 0 -N \\
 -o ServerAliveInterval=30 \\
 -o ServerAliveCountMax=3 \\
 -o ExitOnForwardFailure=yes \\
 -R 0.0.0.0:0:localhost:%i \\
 tunnel@${SERVER}
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload

# ════════════════════════════════════════════════════════════════
# Create CLI manager
# ════════════════════════════════════════════════════════════════

cat > /usr/local/bin/tunnel <<'EOF'
#!/bin/bash

SERVICE="kelpnodes"

GREEN="\e[32m"
RED="\e[31m"
YELLOW="\e[33m"
CYAN="\e[36m"
RESET="\e[0m"

banner(){
echo -e "${CYAN}"
echo "██╗  ██╗███████╗██╗     ██████╗ ███╗   ██╗ ██████╗ ██████╗ ███████╗███████╗"
echo "██║ ██╔╝██╔════╝██║     ██╔══██╗████╗  ██║██╔═══██╗██╔══██╗██╔════╝██╔════╝"
echo "█████╔╝ █████╗  ██║     ██████╔╝██╔██╗ ██║██║   ██║██║  ██║█████╗  ███████╗"
echo "██╔═██╗ ██╔══╝  ██║     ██╔═══╝ ██║╚██╗██║██║   ██║██║  ██║██╔══╝  ╚════██║"
echo "██║  ██╗███████╗███████╗██║     ██║ ╚████║╚██████╔╝██████╔╝███████╗███████║"
echo "╚═╝  ╚═╝╚══════╝╚══════╝╚═╝     ╚═╝  ╚═══╝ ╚═════╝ ╚═════╝ ╚══════╝╚══════╝"
echo -e "${RESET}"
}

validate_port(){
if [[ ! "$1" =~ ^[0-9]+$ ]] || [ "$1" -lt 1 ] || [ "$1" -gt 65535 ]; then
    echo -e "${RED}Invalid port (1-65535)${RESET}"
    exit 1
fi
}

case "$1" in

create)
    validate_port "$2"
    systemctl enable ${SERVICE}@${2}
    systemctl start ${SERVICE}@${2}
    echo -e "${GREEN}Tunnel created on port $2${RESET}"
    ;;

stop)
    validate_port "$2"
    systemctl stop ${SERVICE}@${2}
    systemctl disable ${SERVICE}@${2}
    echo -e "${YELLOW}Tunnel stopped on port $2${RESET}"
    ;;

restart)
    validate_port "$2"
    systemctl restart ${SERVICE}@${2}
    echo -e "${CYAN}Tunnel restarted on port $2${RESET}"
    ;;

status)
    validate_port "$2"
    systemctl status ${SERVICE}@${2}
    ;;

list)
    banner
    systemctl list-units --type=service | grep ${SERVICE}@ || echo "No active tunnels."
    ;;

logs)
    validate_port "$2"
    journalctl -u ${SERVICE}@${2} -f
    ;;

*)
    banner
    echo
    echo "Usage:"
    echo "  tunnel create <port>"
    echo "  tunnel stop <port>"
    echo "  tunnel restart <port>"
    echo "  tunnel status <port>"
    echo "  tunnel list"
    echo "  tunnel logs <port>"
    ;;
esac
EOF

chmod +x /usr/local/bin/tunnel

echo
echo "══════════════════════════════════════"
echo " KelpNodes Tunnel Installed Successfully"
echo " Server: ${SERVER}"
echo "══════════════════════════════════════"
echo
echo "Commands:"
echo "  tunnel create 3000"
echo "  tunnel list"
echo "  tunnel stop 3000"
echo
