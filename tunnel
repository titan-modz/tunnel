#!/bin/bash
# ══════════════════════════════════════════════════════════════════
#  KelpNodes Tunnel v2.1 - Persistent 24/7 Port Forwarding
# ══════════════════════════════════════════════════════════════════

SERVER="57.128.42.40"
USER="tunnel"
SSH_PORT=22

CONFIG_DIR="$HOME/.kelpnodes-tunnel"
KEY_FILE="$CONFIG_DIR/.key"
LOG_DIR="$CONFIG_DIR/logs"
PID_DIR="$CONFIG_DIR/pids"

mkdir -p "$CONFIG_DIR" "$LOG_DIR" "$PID_DIR" 2>/dev/null
chmod 700 "$CONFIG_DIR" 2>/dev/null

# Colors
RED="\e[31m"; GRN="\e[32m"; YEL="\e[33m"; CYN="\e[36m"; WHT="\e[97m"
GRY="\e[90m"; BOLD="\e[1m"; DIM="\e[2m"; UNDER="\e[4m"; BLINK="\e[5m"; RST="\e[0m"

# ══════════════════════════════════════════════════════════════════
#  EMBEDDED RESTRICTED SSH KEY
# ══════════════════════════════════════════════════════════════════
setup_key(){
if [ ! -f "$KEY_FILE" ]; then
cat >"$KEY_FILE"<<'KEY'
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACBJEK7mHycRjc8BFmcqL7PjJFgcDaRhFaDPinB8fjS54wAAAJhiOSxDYjks
QwAAAAtzc2gtZWQyNTUxOQAAACBJEK7mHycRjc8BFmcqL7PjJFgcDaRhFaDPinB8fjS54w
AAAEAy5wkmy3eoL+/RPuv+kv0s473dRWyOCFmvTBUCLPn89EkQruYfJxGNzwEWZyovs+Mk
WBwNpGEVoM+KcHx+NLnjAAAAFXR1bm5lbC1yZXN0cmljdGVkLWtleQ==
-----END OPENSSH PRIVATE KEY-----
KEY
chmod 600 "$KEY_FILE"
fi
}

# ══════════════════════════════════════════════════════════════════
#  DISPLAY
# ══════════════════════════════════════════════════════════════════
banner(){
clear
echo -e "${GRN}${BOLD}"
echo "   ╔════════════════════════════════════════════════════╗"
echo "   ║        ⚡  KelpNodes Tunnel v2.1  ⚡              ║"
echo "   ╚════════════════════════════════════════════════════╝"
echo -e "${RST}"
echo -e "${GRY}${DIM}   Server: $SERVER  •  24/7 Persistent Mode${RST}"
echo
}

# ══════════════════════════════════════════════════════════════════
#  PERSISTENT TUNNEL
# ══════════════════════════════════════════════════════════════════
start_tunnel(){

local port="$1"
local pid_file="$PID_DIR/tunnel-$port.pid"
local map_file="$CONFIG_DIR/.port-$port"
local log_file="$LOG_DIR/tunnel-$port.log"

banner

if [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
echo -e "${RED}Invalid port (1-65535)${RST}"
exit 1
fi

if [ -f "$pid_file" ]; then
local pid=$(cat "$pid_file")
if kill -0 "$pid" 2>/dev/null; then
echo -e "${YEL}Tunnel already running for port $port${RST}"
exit 0
fi
fi

setup_key

echo -e "${CYN}Starting persistent tunnel...${RST}"

(
while true; do
    ssh -i "$KEY_FILE" \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o ExitOnForwardFailure=yes \
    -o ServerAliveInterval=30 \
    -o ServerAliveCountMax=3 \
    -o ConnectTimeout=10 \
    -N \
    -R 0:localhost:$port \
    $USER@$SERVER \
    -p $SSH_PORT >>"$log_file" 2>&1

    echo "$(date) - Disconnected. Reconnecting in 5 seconds..." >>"$log_file"
    sleep 5
done
) &

local loop_pid=$!
echo "$loop_pid" > "$pid_file"

sleep 3

# Try detecting allocated remote port
local remote_port=$(grep "Allocated port" "$log_file" | grep -oE '[0-9]{4,5}' | head -1)
[ -n "$remote_port" ] && echo "$remote_port" > "$map_file"

echo
echo -e "${GRN}✓ Tunnel Running 24/7${RST}"
echo -e "${GRY}Local:${RST} localhost:$port"

if [ -n "$remote_port" ]; then
echo -e "${GRY}Public:${RST} http://$SERVER:$remote_port"
fi

echo
}

stop_tunnel(){
local port="$1"
local pid_file="$PID_DIR/tunnel-$port.pid"
local map_file="$CONFIG_DIR/.port-$port"

if [ ! -f "$pid_file" ]; then
echo -e "${YEL}No tunnel for port $port${RST}"
exit 1
fi

local pid=$(cat "$pid_file")
kill "$pid" 2>/dev/null
rm -f "$pid_file" "$map_file"

echo -e "${GRN}Tunnel stopped for port $port${RST}"
}

list_tunnels(){
banner
echo "Active Tunnels:"
echo

for pid_file in "$PID_DIR"/tunnel-*.pid; do
[ -f "$pid_file" ] || continue
local pid=$(cat "$pid_file")
local port=$(basename "$pid_file" .pid | sed 's/tunnel-//')

if kill -0 "$pid" 2>/dev/null; then
local remote=$(cat "$CONFIG_DIR/.port-$port" 2>/dev/null)
echo "Port $port → http://$SERVER:$remote"
else
rm -f "$pid_file"
fi
done

echo
}

case "${1:-help}" in
[0-9]*) start_tunnel "$1" ;;
stop) stop_tunnel "$2" ;;
list) list_tunnels ;;
*) echo "Usage: tunnel <port> | tunnel stop <port> | tunnel list" ;;
esac
