#!/bin/bash
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  KelpNodes Tunnel v2.0 - Advanced Port Forwarding
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SERVER="57.128.42.40"
USER="tunnel"
SSH_PORT=22

CONFIG_DIR="$HOME/.kelpnodes-tunnel"
KEY_FILE="$CONFIG_DIR/.key"
LOG_DIR="$CONFIG_DIR/logs"
PID_DIR="$CONFIG_DIR/pids"

mkdir -p "$CONFIG_DIR" "$LOG_DIR" "$PID_DIR" 2>/dev/null
chmod 700 "$CONFIG_DIR" 2>/dev/null

# Colors
RED="\e[31m"; GRN="\e[32m"; YEL="\e[33m"; CYN="\e[36m"; WHT="\e[97m"
GRY="\e[90m"; BOLD="\e[1m"; DIM="\e[2m"; UNDER="\e[4m"; BLINK="\e[5m"; RST="\e[0m"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  EMBEDDED RESTRICTED SSH KEY (can ONLY forward ports)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
setup_key(){
if [ ! -f "$KEY_FILE" ];then
cat>"$KEY_FILE"<<'KEY'
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACBJEK7mHycRjc8BFmcqL7PjJFgcDaRhFaDPinB8fjS54wAAAJhiOSxDYjks
QwAAAAtzc2gtZWQyNTUxOQAAACBJEK7mHycRjc8BFmcqL7PjJFgcDaRhFaDPinB8fjS54w
AAAEAy5wkmy3eoL+/RPuv+kv0s473dRWyOCFmvTBUCLPn89EkQruYfJxGNzwEWZyovs+Mk
WBwNpGEVoM+KcHx+NLnjAAAAFXR1bm5lbC1yZXN0cmljdGVkLWtleQ==
-----END OPENSSH PRIVATE KEY-----
KEY
chmod 600 "$KEY_FILE"
fi
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  DISPLAY FUNCTIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

banner(){
clear
echo -e "${GRN}${BOLD}"
echo "   ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "   ‚ïë                                                    ‚ïë"
echo "   ‚ïë        ${WHT}‚ö°  KelpNodes Tunnel v2.0  ‚ö°${GRN}         ‚ïë"
echo "   ‚ïë                                                    ‚ïë"
echo "   ‚ïë         ${DIM}Secure Port Forwarding Service${GRN}          ‚ïë"
echo "   ‚ïë                                                    ‚ïë"
echo "   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${RST}"
echo -e "${GRY}${DIM}   Server: $SERVER  ‚Ä¢  üîí Secure  ‚Ä¢  Status: ${GRN}ONLINE${RST}"
echo
}

box(){
local msg="$1"
local color="${2:-$GRN}"
echo -e "${color}${BOLD}"
echo "   ‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì"
echo "   ‚îÉ   $msg"
echo "   ‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ"
echo -e "${RST}"
}

dots(){
printf "   ${CYN}$1${RST}"
for i in 1 2 3;do printf ".";sleep 0.15;done
echo
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  TUNNEL OPERATIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

start_tunnel(){
local port="$1"
local pid_file="$PID_DIR/tunnel-$port.pid"
local map_file="$CONFIG_DIR/.port-$port"
local log_file="$LOG_DIR/tunnel-$port.log"

banner

if [ $port -lt 1 ]||[ $port -gt 65535 ];then
echo -e "   ${RED}‚úó${RST} ${BOLD}Invalid port${RST} (must be 1-65535)"
return 1
fi

if [ -f "$pid_file" ];then
local pid=$(cat "$pid_file")
if kill -0 "$pid" 2>/dev/null;then
local remote=$(cat "$map_file" 2>/dev/null||echo "?")
echo -e "   ${YEL}‚ö†${RST} Tunnel already active for port ${BOLD}$port${RST}"
echo
echo -e "   ${CYN}üîó${RST} Public URL: ${GRN}${BOLD}http://$SERVER:$remote${RST}"
echo
return 0
fi
fi

setup_key

echo -e "   ${CYN}üöÄ${RST} ${BOLD}Starting Tunnel${RST}"
echo
echo -e "   ${GRY}Local:${RST}    ${WHT}${BOLD}localhost:$port${RST}"
echo -e "   ${GRY}Server:${RST}   ${WHT}$SERVER${RST}"
echo -e "   ${GRY}Security:${RST} ${GRN}üîí SSH Key Auth${RST}"
echo

dots "Connecting"

ssh -i "$KEY_FILE" \
-o StrictHostKeyChecking=no \
-o UserKnownHostsFile=/dev/null \
-o ExitOnForwardFailure=yes \
-o ServerAliveInterval=100w \
-o ServerAliveCountMax=30 \
-o ConnectTimeout=10 \
-N -f \
-R 0:localhost:$port \
$USER@$SERVER \
-p $SSH_PORT \
>"$log_file" 2>&1

sleep 3

if grep -q "Allocated port" "$log_file" 2>/dev/null;then
local remote_port=$(grep "Allocated port" "$log_file"|grep -oE '[0-9]{4,5}'|head -1)
echo "$remote_port">"$map_file"
local ssh_pid=$(pgrep -f "ssh.*-R.*$port.*$SERVER"|head -1)
[ -n "$ssh_pid" ]&&echo "$ssh_pid">"$pid_file"

echo
box "‚úì  TUNNEL ACTIVE  ‚úì" "$GRN"
echo
echo -e "   ${BOLD}‚ïê‚ïê‚ïê Connection Details ‚ïê‚ïê‚ïê${RST}"
echo
echo -e "   ${GRY}‚îú‚îÄ${RST} Local:  ${WHT}localhost:$port${RST}"
echo -e "   ${GRY}‚îú‚îÄ${RST} Remote: ${GRN}${BOLD}$remote_port${RST}"
echo -e "   ${GRY}‚îú‚îÄ${RST} PID:    ${GRY}$ssh_pid${RST}"
echo -e "   ${GRY}‚îî‚îÄ${RST} Status: ${GRN}${BLINK}‚óè${RST} ${GRN}ONLINE${RST}"
echo
echo -e "   ${CYN}${BOLD}üî• Share This URL:${RST}"
echo
echo -e "      ${GRN}${BOLD}${UNDER}http://$SERVER:$remote_port${RST}"
echo
echo -e "   ${GRY}${DIM}üí° Tip: Run 'tunnel list' to see all tunnels${RST}"
echo
else
echo -e "   ${RED}‚úó${RST} Connection failed"
echo -e "   ${YEL}Log:${RST} $log_file"
return 1
fi
}

stop_tunnel(){
local port="$1"
local pid_file="$PID_DIR/tunnel-$port.pid"
local map_file="$CONFIG_DIR/.port-$port"

if [ ! -f "$pid_file" ];then
echo -e "   ${YEL}‚ö†${RST} No tunnel for port $port"
return 1
fi

local pid=$(cat "$pid_file")
dots "Stopping tunnel"

if kill "$pid" 2>/dev/null;then
rm -f "$pid_file" "$map_file"
echo -e "   ${GRN}‚úì${RST} Tunnel stopped for port ${BOLD}$port${RST}"
else
rm -f "$pid_file" "$map_file"
echo -e "   ${YEL}‚ö†${RST} Process not found"
fi
}

list_tunnels(){
banner
echo -e "   ${BOLD}${UNDER}Active Tunnels${RST}"
echo

local count=0
for pid_file in "$PID_DIR"/tunnel-*.pid;do
[ -f "$pid_file" ]||continue
local pid=$(cat "$pid_file" 2>/dev/null)
local port=$(basename "$pid_file" .pid|sed 's/tunnel-//')

if kill -0 "$pid" 2>/dev/null;then
local remote=$(cat "$CONFIG_DIR/.port-$port" 2>/dev/null||echo "?")
count=$((count+1))
echo -e "   ${CYN}${BOLD}[$count]${RST} ${GRN}‚óè${RST} ${BOLD}Port $port${RST}"
echo -e "       ${GRY}‚îú‚îÄ${RST} Local:    ${WHT}localhost:$port${RST}"
echo -e "       ${GRY}‚îî‚îÄ${RST} Remote:   ${GRN}${BOLD}http://$SERVER:$remote${RST}"
echo
else
rm -f "$pid_file"
fi
done

if [ $count -eq 0 ];then
echo -e "   ${GRY}${DIM}No active tunnels${RST}"
echo
echo -e "   ${CYN}‚Ñπ${RST} Start one with: ${BOLD}tunnel <port>${RST}"
fi
echo
}

stop_all(){
banner
echo -e "   ${YEL}üõë${RST} ${BOLD}Stopping all tunnels...${RST}"
echo

for pid_file in "$PID_DIR"/tunnel-*.pid;do
[ -f "$pid_file" ]||continue
local port=$(basename "$pid_file" .pid|sed 's/tunnel-//')
local pid=$(cat "$pid_file")
kill "$pid" 2>/dev/null
rm -f "$pid_file" "$CONFIG_DIR/.port-$port"
echo -e "   ${GRN}‚úì${RST} Stopped port $port"
done

echo
}

show_help(){
banner
echo "   Usage:"
echo
echo "   tunnel <port>"
echo "   tunnel stop <port>"
echo "   tunnel list"
echo "   tunnel stop-all"
echo
}

if ! command -v ssh &>/dev/null;then
echo -e "${RED}‚úó${RST} ssh not installed"
exit 1
fi

case "${1:-help}" in
[0-9]*) start_tunnel "$1" ;;
stop) stop_tunnel "$2" ;;
list|ls) list_tunnels ;;
stop-all) stop_all ;;
*) show_help ;;
esac
